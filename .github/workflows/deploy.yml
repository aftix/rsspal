name: Deploy rsspal

on:
  workflow_run:
    workflows: ['main']
    branches: ['master']
    types:
      - completed


jobs:
  deploy:
    name: Deploy rsspal to server
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    concurrency:
      group: deploy
      cancel-in-progress: true
    steps:
      - name: Get latest code
        uses: actions/checkout@v3

      - name: Get ssh key from secrets
        run: install -m 600 -D /dev/stdin $HOME/.ssh/id_ed25519 <<< "${{ secrets.SSH_PRIVATE_KEY }}"

      - name: Add known hosts to .ssh directory
        run: |
          ssh-keyscan -H "${{ secrets.SERVER }}" > $HOME/.ssh/known_hosts
      
      # Requires sshd on server to AcceptEnv DISCORD_TOKEN
      - name: Run deployment script on server
        run: >
          ssh -o "SendEnv DISCORD_TOKEN"
          "${{ secrets.USER }}@${{ secrets.SERVER }}"
          'sh -ls' < install_script.sh
        env:
          DISCORD_TOKEN: "${{ secrets.DISCORD_TOKEN }}"